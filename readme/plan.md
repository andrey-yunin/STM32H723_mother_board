# План работ: Переход на бинарный протокол USB CDC

## Цель этапа:
Полностью завершить переход микроконтроллера на бинарный протокол обмена данными по USB, включая прием команд, отправку ответов и интеграцию с JobManager для обработки команд.

## Выполненные шаги (отражено в report.md):
*   Объявление и создание FreeRTOS Stream Buffer для приема данных.
*   Модификация функции приема USB CDC (`usbd_cdc_if.c`).
*   Модификация задачи-диспетчера (`task_dispatcher.c`) для сборки бинарных пакетов.
*   Создание функции обработки бинарных команд (`command_parser.c`).
*   Создание функции отправки бинарных ответов (`dispatcher_io.c`).
*   Корректировка `app_init_checker.c`.
*   Обновление `App_user/test_protocol.py` для отправки команды `INIT`.

## Оставшиеся шаги реализации:

### 1. Тестирование взаимодействия с ПК:
*   **1.1. Тест с `App_user/test_protocol.py`**: Запустить скрипт для отправки команды `INIT` и убедиться, что микроконтроллер отвечает бинарным ACK-пакетом.

### 2. Адаптация `task_usb_handler.c` для бинарных данных:
*   **2.1. Изменить `App/Src/Tasks/task_usb_handler.c`**:
    *   Модифицировать функцию, чтобы она могла принимать и отправлять как строки (для отладочных сообщений), так и бинарные пакеты. Это может потребовать изменения типа `usb_tx_queue_handle` или введения отдельного Stream Buffer для бинарных TX данных. Пока `usb_tx_queue_handle` используется для передачи `uint8_t*`, необходимо убрать логику добавления `\r\n` и обработать `len` как фактическую длину бинарных данных.

### 3. Расширение логики `Parser_ProcessBinaryCommand`:
*   **3.1. Реализация обработки команды `INIT`**:
    *   В функции `Parser_ProcessBinaryCommand` добавить логику для команды `0x1002` (INIT).
    *   Инициировать запуск соответствующего задания через `JobManager_StartNewJob`.
    *   Дождаться завершения задания и отправить `DONE`-ответ (0x02) или `ERROR`-ответ (0x04) в зависимости от результата выполнения Job'а.

### 4. Доработка функций ответов:
*   **4.1. Добавление `Dispatcher_SendDone` и `Dispatcher_SendError`**:
    *   Создать в `dispatcher_io.h` и `dispatcher_io.c` функции для отправки `DONE`- и `ERROR`-ответов согласно протоколу.

## Зависимости:
*   FreeRTOS (Stream Buffer API, Queue API, Semaphore API).
*   Correct operation of USB CDC.

## Тестирование:
*   После каждого шага, компиляция и проверка на отсутствие ошибок.
*   Использование `App_user/test_protocol.py` для валидации бинарного обмена.