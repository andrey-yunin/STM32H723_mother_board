# Примеры использования команд DDS-240

## Содержание

1. [Базовые операции](#1-базовые-операции)
2. [Цикл анализа образца](#2-цикл-анализа-образца)
3. [Промывка системы](#3-промывка-системы)
4. [Калибровка фотометра](#4-калибровка-фотометра)
5. [Работа с термостатом](#5-работа-с-термостатом)
6. [Сканирование штрихкодов](#6-сканирование-штрихкодов)
7. [Обработка ответов](#7-обработка-ответов)

---

## 1. Базовые операции

### 1.1. Инициализация анализатора

Перед началом работы необходимо инициализировать все модули:

```
Команда: INIT (0x1002), все модули (0xFF)

TX: 43 4D 3E 00 04 10 02 FF ED
    │  │  │  │  │  │  │  │  └── CRC = 0x10 XOR 0x02 XOR 0xFF = 0xED
    │  │  │  │  │  │  │  └───── Параметр: все модули
    │  │  │  │  │  └──┴──────── Команда: 0x1002
    │  │  │  └──┴────────────── Длина: 4 байта
    └──┴──┴──────────────────── Шапка: CM>

RX (ACK): 43 4D 3E 00 06 10 02 01 00 00 13
          │           │  │  │  │  │  │  └── CRC
          │           │  │  │  │  └──┴───── Статус: OK
          │           │  │  │  └─────────── Тип: ACK (0x01)
          │           └──┴──┴────────────── Команда: 0x1002

RX (DONE): 43 4D 3E 00 06 10 02 02 00 00 10
           │           │  │  │  │  │  │  └── CRC
           │           │  │  │  │  └──┴───── Статус: OK
           │           │  │  │  └─────────── Тип: DONE (0x02)
           │           └──┴──┴────────────── Команда: 0x1002
```

### 1.2. Запрос состояния

```
Команда: GET_STATUS (0x1000)

TX: 43 4D 3E 00 03 10 00 10
    │  │  │  │  │  │  │  └── CRC = 0x10 XOR 0x00 = 0x10
    │  │  │  │  │  └──┴───── Команда: 0x1000
    │  │  │  └──┴──────────── Длина: 3 байта
    └──┴──┴────────────────── Шапка: CM>

RX (ACK): 43 4D 3E 00 06 10 00 01 00 00 11

RX (DATA): 43 4D 3E 00 08 10 00 03 00 00 01 00 00 12
           │           │  │  │  │  │  │  │  │  │  └── CRC
           │           │  │  │  │  │  │  │  └──┴───── Код ошибки: 0
           │           │  │  │  │  │  │  └─────────── Статус: 1 (готов)
           │           │  │  │  │  └──┴────────────── Статус ответа: OK
           │           │  │  │  └──────────────────── Тип: DATA (0x03)
           │           └──┴──┴─────────────────────── Команда: 0x1000

RX (DONE): 43 4D 3E 00 06 10 00 02 00 00 12
```

---

## 2. Цикл анализа образца

Типичная последовательность для выполнения одного анализа:

### Шаг 1: Поворот диска образцов к нужной позиции

```
Команда: SAMPLE_ROTATE (0x5110), позиция #5

TX: 43 4D 3E 00 05 51 10 00 05 44
    │           │  │  └──┴── Позиция: 5
    │           └──┴──────── Команда: 0x5110
    └─────────────────────── Шапка + Длина

CRC = 0x51 XOR 0x10 XOR 0x00 XOR 0x05 = 0x44
```

### Шаг 2: Забор образца дозатором

```
Команда: DISPENSER_ASPIRATE (0x2100)
- Дозатор #1
- Источник: диск образцов (0x03)
- Позиция: #5
- Объём: 10 мкл (0x000A)

TX: 43 4D 3E 00 09 21 00 01 03 00 05 00 0A 2C
    │           │  │  │  │  │  │  └──┴── Объём: 10 мкл
    │           │  │  │  │  └──┴─────── Позиция: 5
    │           │  │  │  └───────────── Источник: диск образцов
    │           │  │  └──────────────── Дозатор: #1
    │           └──┴─────────────────── Команда: 0x2100

CRC = 0x21 XOR 0x00 XOR 0x01 XOR 0x03 XOR 0x00 XOR 0x05 XOR 0x00 XOR 0x0A = 0x2C
```

### Шаг 3: Выдача образца в кювету

```
Команда: DISPENSER_DISPENSE (0x2200)
- Дозатор #1
- Назначение: реакционный диск (0x01)
- Кювета: #10
- Объём: 10 мкл

TX: 43 4D 3E 00 09 22 00 01 01 00 0A 00 0A 22
    │           │  │  │  │  │  │  └──┴── Объём: 10 мкл
    │           │  │  │  │  └──┴─────── Кювета: 10
    │           │  │  │  └───────────── Назначение: реакционный диск
    │           │  │  └──────────────── Дозатор: #1
    │           └──┴─────────────────── Команда: 0x2200
```

### Шаг 4: Забор реагента

```
Команда: REAGENT_ROTATE (0x5000) - поворот ротора к позиции реагента
- Ротор #1, слот #3

TX: 43 4D 3E 00 06 50 00 01 00 03 52

Команда: DISPENSER_ASPIRATE (0x2100)
- Дозатор #1
- Источник: ротор реагентов (0x02)
- Позиция: #3
- Объём: 200 мкл (0x00C8)

TX: 43 4D 3E 00 09 21 00 01 02 00 03 00 C8 E9
```

### Шаг 5: Выдача реагента в кювету

```
Команда: DISPENSER_DISPENSE (0x2200)
- Дозатор #1
- Назначение: реакционный диск (0x01)
- Кювета: #10
- Объём: 200 мкл

TX: 43 4D 3E 00 09 22 00 01 01 00 0A 00 C8 E1
```

### Шаг 6: Перемешивание

```
Команда: MIXER_MIX (0x3100)
- Миксер #1
- Кювета: #10
- Время: 3000 мс (0x0BB8)
- Промывок после: 2

TX: 43 4D 3E 00 09 31 00 01 00 0A 0B B8 02 81
    │           │  │  │  │  │  └──┴── Время: 3000 мс
    │           │  │  │  └──┴─────── Кювета: 10
    │           │  │  └──────────── Миксер: #1
    │           └──┴─────────────── Команда: 0x3100
```

### Шаг 7: Фотометрия

```
Команда: PHOTOMETER_SCAN_SINGLE (0x6100)
- Кювета: #10
- Длины волн: 340 нм и 405 нм (маска 0x03)

TX: 43 4D 3E 00 06 61 00 00 0A 03 68
    │           │  │  │  │  │  └── Маска длин волн
    │           │  │  └──┴──┴───── Кювета: 10
    │           └──┴────────────── Команда: 0x6100

RX (DATA): 43 4D 3E 00 16 61 00 03 00 00 00 0A [16 байт данных АЦП] [CRC]
           │           │  │  │  │  │  └──┴── Кювета: 10
           │           │  │  │  └──┴─────── Статус: OK
           │           │  │  └───────────── Тип: DATA
           │           └──┴──────────────── Команда: 0x6100
```

---

## 3. Промывка системы

### 3.1. Полная промывка дозатора

```
Команда: DISPENSER_WASH (0x2000)
- Дозатор #1
- Объём: 1000 мкл (0x03E8)
- Циклов: 5

TX: 43 4D 3E 00 07 20 00 01 03 E8 05 CF
    │           │  │  │  │  │  │  └── Число циклов: 5
    │           │  │  │  │  └──┴───── Объём: 1000 мкл
    │           │  │  │  └─────────── Дозатор: #1
    │           └──┴──┴────────────── Команда: 0x2000

CRC = 0x20 XOR 0x00 XOR 0x01 XOR 0x03 XOR 0xE8 XOR 0x05 = 0xCF
```

### 3.2. Промывка кювет на моющей станции

```
Команда: WASH_STATION_WASH (0x4000)
- Циклов: 3
- Кювета: #10

TX: 43 4D 3E 00 06 40 00 03 00 0A 49

После промывки - заполнение водой:

Команда: WASH_STATION_FILL (0x4100)
- Объём: 300 мкл (0x012C)
- Кювета: #10

TX: 43 4D 3E 00 07 41 00 01 2C 00 0A 76
```

---

## 4. Калибровка фотометра

### 4.1. Калибровка по воздуху

```
Команда: PHOTOMETER_CALIBRATE (0x6200)
- Тип: воздух (0x00)
- Все длины волн (0xFF)

TX: 43 4D 3E 00 05 62 00 00 FF 9D
```

### 4.2. Калибровка по воде

```
Команда: PHOTOMETER_CALIBRATE (0x6200)
- Тип: вода (0x01)
- Все длины волн (0xFF)

TX: 43 4D 3E 00 05 62 00 01 FF 9C
```

### 4.3. Запрос доступных длин волн

```
Команда: PHOTOMETER_GET_WAVELENGTHS (0x6300)

TX: 43 4D 3E 00 03 63 00 63

RX (DATA): 43 4D 3E 00 15 63 00 03 00 00 08 01 54 01 95 01 C2 01 FE 02 22 02 42 02 76 02 BC [CRC]
           │           │  │  │  │  │  │  └─────────────────────────────────────────────────── Длины волн
           │           │  │  │  │  │  └── Количество: 8
           │           │  │  │  └──┴───── Статус: OK
           │           │  │  └─────────── Тип: DATA
           │           └──┴────────────── Команда: 0x6300

Расшифровка длин волн:
0x0154 = 340 нм
0x0195 = 405 нм
0x01C2 = 450 нм
0x01FE = 510 нм
0x0222 = 546 нм
0x0242 = 578 нм
0x0276 = 630 нм
0x02BC = 700 нм
```

---

## 5. Работа с термостатом

### 5.1. Установка температуры реакционного диска

```
Команда: THERMO_SET_TEMP (0x8001)
- Термостат: реакционный диск (0x01)
- Температура: 37.0°C (0x0172 = 370)

TX: 43 4D 3E 00 06 80 01 01 01 72 F3
    │           │  │  │  │  └──┴── Температура: 370 (37.0°C)
    │           │  │  │  └──────── Термостат: #1
    │           └──┴──┴─────────── Команда: 0x8001

CRC = 0x80 XOR 0x01 XOR 0x01 XOR 0x01 XOR 0x72 = 0xF3
```

### 5.2. Включение термостата

```
Команда: THERMO_START (0x8002)
- Термостат: #1

TX: 43 4D 3E 00 04 80 02 01 83
```

### 5.3. Запрос текущей температуры

```
Команда: THERMO_GET_TEMP (0x8000)
- Термостат: #1

TX: 43 4D 3E 00 04 80 00 01 81

RX (DATA): 43 4D 3E 00 0A 80 00 03 00 00 01 6E 01 72 [CRC]
           │           │  │  │  │  │  └──┴── Целевая: 370 (37.0°C)
           │           │  │  │  │  └──┴───── Текущая: 366 (36.6°C)
           │           │  │  │  └──┴──────── Статус: OK
           │           │  │  └────────────── Тип: DATA
           │           └──┴───────────────── Команда: 0x8000
```

### 5.4. Запрос статуса термостата

```
Команда: THERMO_GET_STATUS (0x8010)
- Термостат: #1

TX: 43 4D 3E 00 04 80 10 01 91

RX (DATA): 43 4D 3E 00 0C 80 10 03 00 00 01 01 6E 01 72 50 [CRC]
           │           │  │  │  │  │  │  └──┴── Целевая: 370
           │           │  │  │  │  │  └──┴───── Текущая: 366
           │           │  │  │  │  └─────────── Статус: 1 (нагрев)
           │           │  │  │  └──┴──────────── Статус ответа: OK
           │           │  │  └─────────────────── Тип: DATA
           │           └──┴────────────────────── Команда: 0x8010

Последний байт перед CRC: мощность 80% (0x50)

Статусы:
0 - выключен
1 - нагрев
2 - охлаждение
3 - готов (температура достигнута)
```

---

## 6. Сканирование штрихкодов

### 6.1. Сканирование всех реагентов

```
Команда: REAGENT_SCAN_BARCODE (0x5100)
- Ротор #1
- Слот: 0 (все)

TX: 43 4D 3E 00 06 51 00 01 00 00 50

RX (ACK): 43 4D 3E 00 06 51 00 01 00 00 50

RX (DATA для слота 1): 43 4D 3E 00 12 51 00 03 00 00 00 01 52 45 41 47 45 4E 54 31 [CRC]
                       │           │  │  │  │  │  └──┴── Позиция: 1
                       │           │  │  │  │  └──────── ... штрихкод "REAGENT1"

RX (DATA для слота 2): 43 4D 3E 00 12 51 00 03 00 00 00 02 52 45 41 47 45 4E 54 32 [CRC]
...

RX (DONE): 43 4D 3E 00 06 51 00 02 00 00 53
```

### 6.2. Сканирование конкретного образца

```
Команда: SAMPLE_SCAN_BARCODE (0x5120)
- Позиция: #5

TX: 43 4D 3E 00 05 51 20 00 05 74

RX (DATA): 43 4D 3E 00 14 51 20 03 00 00 00 05 50 41 54 49 45 4E 54 30 30 35 [CRC]
           │                          └──┴── Позиция: 5
           │                               └───────────────────────────────── Штрихкод "PATIENT005"
```

---

## 7. Обработка ответов

### 7.1. Алгоритм разбора ответа

```
1. Прочитать 3 байта шапки, проверить == "CM>" (0x43 0x4D 0x3E)
2. Прочитать 2 байта длины
3. Прочитать (длина) байт данных
4. Последний байт данных - CRC
5. Вычислить CRC и сравнить
6. Разобрать структуру ответа:
   - Команда (2 байта)
   - Тип ответа (1 байт)
   - Статус (2 байта)
   - Данные (остаток)
```

### 7.2. Обработка ошибок

При получении статуса != 0x0000:

```
Пример ответа с ошибкой:

RX: 43 4D 3E 00 06 20 00 02 10 01 33
    │           │  │  │  │  └──┴── Код ошибки: 0x1001 (ERR_DISP_NOT_FOUND)
    │           │  │  │  └──────── Тип: DONE
    │           └──┴──┴─────────── Команда: 0x2000

Действия:
1. Проверить код ошибки по таблице (см. errors.md)
2. Если ошибка критическая - остановить выполнение
3. Если ошибка восстанавливаемая - выполнить INIT и повторить
4. Записать ошибку в журнал
```

### 7.3. Таймауты и повторы

```
Псевдокод отправки команды:

функция send_command(command, params):
    пакет = build_packet(command, params)

    для попытки от 1 до 3:
        отправить(пакет)

        ответ = ожидать_ack(500мс)
        если ответ == таймаут:
            продолжить  // повторить
        если ответ.статус != OK:
            вернуть ошибку(ответ.статус)

        // ACK получен, ждём DONE
        пока истина:
            ответ = ожидать_ответ(60сек)
            если ответ == таймаут:
                вернуть ошибку(TIMEOUT)
            если ответ.тип == DATA:
                обработать_данные(ответ.данные)
            если ответ.тип == DONE:
                вернуть ответ.статус
            если ответ.тип == ERROR:
                вернуть ошибку(ответ.статус)

    вернуть ошибку(NO_RESPONSE)
```
