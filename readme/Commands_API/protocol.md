# Протокол обмена данными DDS-240

## 1. Общее описание

Протокол обмена данными предназначен для управления биохимическим анализатором DDS-240 от управляющего ПК. Связь осуществляется по последовательному порту (COM/USB) или по сети (TCP/IP).

### Характеристики протокола:
- Тип: полудуплексный, запрос-ответ
- Порядок байт: Big-endian (старший байт первым)
- Кодировка: бинарный формат

---

## 2. Формат пакета команды

Каждый пакет команды от ПК к анализатору имеет следующую структуру:

```
┌─────────┬─────────┬──────────┬────────────┬───────┐
│  Шапка  │  Длина  │ Команда  │ Параметры  │  CRC  │
│ 3 байта │ 2 байта │ 2 байта  │  N байт    │1 байт │
└─────────┴─────────┴──────────┴────────────┴───────┘
```

### 2.1. Шапка (Header)
- **Размер**: 3 байта
- **Значение**: `0x43 0x4D 0x3E` (ASCII: `CM>`)
- **Назначение**: идентификация начала пакета

### 2.2. Длина (Length)
- **Размер**: 2 байта
- **Значение**: количество байт после поля длины (команда + параметры + CRC)
- **Диапазон**: 0x0003 - 0xFFFF

### 2.3. Команда (Command)
- **Размер**: 2 байта
- **Формат**: старший байт определяет группу команд, младший - конкретную команду
- **Группы команд**:
  - `0x10xx` - Системные команды
  - `0x20xx` - Команды дозатора
  - `0x30xx` - Команды миксера
  - `0x40xx` - Команды моющей станции
  - `0x50xx` - Команды ротора реагентов
  - `0x51xx` - Команды диска образцов
  - `0x60xx` - Команды фотометра
  - `0x70xx` - Команды реакционного диска
  - `0x80xx` - Команды термостатирования
  - `0x90xx` - Команды датчиков (жидкость, температура, положение)

### 2.4. Параметры (Parameters)
- **Размер**: переменный (0 - N байт)
- **Содержимое**: зависит от конкретной команды

### 2.5. CRC (Контрольная сумма)
- **Размер**: 1 байт
- **Алгоритм**: XOR всех байт от поля "Команда" до последнего байта "Параметров"

---

## 3. Формат пакета ответа

Анализатор отвечает на каждую команду в следующем формате:

```
┌─────────┬─────────┬──────────┬───────┬──────────┬─────────────┬───────┐
│  Шапка  │  Длина  │ Команда  │  Тип  │  Статус  │   Данные    │  CRC  │
│ 3 байта │ 2 байта │ 2 байта  │1 байт │ 2 байта  │   N байт    │1 байт │
└─────────┴─────────┴──────────┴───────┴──────────┴─────────────┴───────┘
```

### 3.1. Тип ответа
- **Размер**: 1 байт
- **Значения**:
  - `0x01` - **ACK** (подтверждение получения команды)
  - `0x02` - **DONE** (команда выполнена)
  - `0x03` - **DATA** (передача данных)
  - `0x04` - **ERROR** (ошибка)

### 3.2. Статус
- **Размер**: 2 байта
- **Значения**:
  - `0x0000` - успешно (OK)
  - `0x0001` и выше - код ошибки (см. errors.md)

### 3.3. Данные
- **Размер**: переменный
- **Содержимое**: зависит от типа ответа и команды

---

## 4. Последовательность обмена

### 4.1. Простая команда (без возврата данных)

```
ПК                          Анализатор
 │                              │
 │──── Команда ────────────────>│
 │                              │
 │<─── ACK (получено) ──────────│
 │                              │
 │       ... выполнение ...     │
 │                              │
 │<─── DONE (выполнено) ────────│
 │                              │
```

### 4.2. Команда с возвратом данных

```
ПК                          Анализатор
 │                              │
 │──── Команда ────────────────>│
 │                              │
 │<─── ACK (получено) ──────────│
 │                              │
 │       ... выполнение ...     │
 │                              │
 │<─── DATA (данные #1) ────────│
 │<─── DATA (данные #2) ────────│
 │<─── DATA (данные #N) ────────│
 │                              │
 │<─── DONE (выполнено) ────────│
 │                              │
```

---

## 5. Расчёт CRC

CRC вычисляется как XOR всех байт от поля "Команда" до последнего байта "Параметров" (или "Данных" для ответа).

### Алгоритм:
```
CRC = Команда[0] XOR Команда[1] XOR Параметры[0] XOR ... XOR Параметры[N-1]
```

### Пример расчёта:
Команда: `0x2000` (промывка дозатора)
Параметры: `0x01 0x03 0xE8 0x02` (дозатор #1, 1000 мкл, 2 раза)

```
CRC = 0x20 XOR 0x00 XOR 0x01 XOR 0x03 XOR 0xE8 XOR 0x02
CRC = 0xC8
```

Полный пакет:
```
43 4D 3E 00 07 20 00 01 03 E8 02 C8
│  │  │  │  │  │  │  │  │  │  │  └── CRC
│  │  │  │  │  │  │  │  │  │  └───── Число промывок
│  │  │  │  │  │  │  │  └──┴─────── Объём (1000 = 0x03E8)
│  │  │  │  │  │  │  └───────────── № дозатора
│  │  │  │  │  └──┴──────────────── Команда 0x2000
│  │  │  └──┴────────────────────── Длина (7 байт)
└──┴──┴──────────────────────────── Шапка CM>
```

---

## 6. Таймауты

| Параметр | Значение | Описание |
|----------|----------|----------|
| T_ACK | 500 мс | Время ожидания ACK после отправки команды |
| T_DONE | 60 сек | Максимальное время выполнения команды |
| T_DATA | 1000 мс | Интервал между пакетами данных |
| T_RETRY | 3 | Количество повторных попыток при отсутствии ACK |

### Обработка таймаутов:
1. Если ACK не получен в течение T_ACK - повторить команду (до T_RETRY раз)
2. Если DONE не получен в течение T_DONE - считать команду невыполненной
3. Если между пакетами DATA прошло более T_DATA - ожидать DONE или ERROR

---

## 7. Типы данных

| Тип | Размер | Описание |
|-----|--------|----------|
| UINT8 | 1 байт | Беззнаковое целое 0-255 |
| UINT16 | 2 байта | Беззнаковое целое 0-65535, Big-endian |
| INT16 | 2 байта | Знаковое целое -32768..32767, Big-endian |
| UINT32 | 4 байта | Беззнаковое целое, Big-endian |
| STRING | N байт | ASCII строка без завершающего нуля, длина определяется по длине пакета |

### Единицы измерения:
- Объём: микролитры (мкл), UINT16
- Температура: десятые доли градуса Цельсия, INT16 (например, 370 = 37.0°C)
- Время: миллисекунды, UINT16 или UINT32
- Оптическая плотность: единицы АЦП, UINT16

---

## 8. Идентификаторы устройств

При адресации к конкретным модулям используются следующие идентификаторы:

| Параметр | Тип | Диапазон | Описание |
|----------|-----|----------|----------|
| dispenser_id | UINT8 | 1-8 | Номер дозатора |
| mixer_id | UINT8 | 1-4 | Номер миксера |
| rotor_id | UINT8 | 1-4 | Номер ротора реагентов |
| cuvette_num | UINT16 | 1-120 | Номер кюветы |
| slot_num | UINT16 | 1-100 | Номер слота (позиции) |
| thermo_id | UINT8 | 1-4 | Номер термостата |

---

## 9. Идентификаторы целевых устройств

При указании источника/назначения жидкости:

| Код | Название | Описание |
|-----|----------|----------|
| 0x01 | REACTION_DISK | Реакционный диск (кюветы) |
| 0x02 | REAGENT_ROTOR | Ротор реагентов |
| 0x03 | SAMPLE_DISK | Диск образцов |
| 0x04 | WASH_STATION | Моющая станция |
| 0x05 | WASTE | Слив (отходы) |
